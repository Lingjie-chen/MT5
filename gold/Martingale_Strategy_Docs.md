# 马丁格尔策略高级优化方案文档

## 1. 策略核心逻辑 (Core Logic)

本方案基于传统的马丁格尔策略进行改良，引入了动态风控和智能加仓机制，旨在提高策略在震荡行情的获利能力，同时显著降低单边趋势中的爆仓风险。

### 1.1 初始仓位 (Initial Position)
*   **机制**: 使用基础手数（Base Lot）开仓。
*   **动态调整**: 虽然以基础手数启动，但结合了 AI (Qwen) 的信号强度。如果 AI 信号极强，基础手数可能会微调（但在马丁序列中仍视为第 1 层）。
*   **代码实现**: `SymbolTrader` 类中的 `lot_size` 参数。

### 1.2 加仓机制 (Add-on Mechanism)
*   **触发条件**: 价格向不利方向变动指定距离。
*   **创新点 - ATR 动态间距**:
    *   不再使用固定的点数（如 200 点），而是基于市场实时波动率 (ATR)。
    *   **公式**: `Grid Distance = Current ATR (14) * 0.8`
    *   **优势**: 在高波动行情中自动拉大加仓间距，避免过早打光子弹；在低波动行情中缩小间距，提高资金利用率。
*   **创新点 - 柔性倍数 (Soft Martingale)**:
    *   放弃激进的固定 2.0 倍投，采用分层倍数：
        *   **第 1-3 层**: `1.0x` (平推，降低成本)
        *   **第 4-6 层**: `1.4x` (中期发力，快速拉低均价)
        *   **第 7+ 层**: `1.1x` (后期保守，防止仓位爆炸)
*   **代码实现**: `grid_strategy.py` 中的 `check_grid_add` 和 `calculate_next_lot`。

### 1.3 退出条件 (Exit Conditions)

#### A. 止盈退出 (Take Profit)
*   **整体止盈 (Basket TP)**: 当所有持仓的**总利润**达到目标值时，一次性平仓所有订单。
*   **动态目标**: 止盈目标根据持仓层数动态调整（层数越多，目标越低，只求快速脱身）。
*   **阶梯锁定 (Step Lock)**: 当利润达到一定高度但未触及 TP 时，激活“利润锁定”功能，确保利润回撤不会超过一定比例（类似移动止损）。

#### B. 强制风控 (Hard Stop)
*   **最大层数限制**: 达到最大加仓层数（默认 10-20 层，视品种而定）后，停止加仓。
*   **最大回撤限制 (Max Drawdown)**:
    *   **机制**: 实时监控账户净值。
    *   **熔断**: 当 `(账户余额 - 净值) / 账户余额 >= 20%` 时，**无条件强制平仓所有头寸**。
    *   **目的**: 留得青山在，不怕没柴烧。防止一次极端黑天鹅事件导致账户归零。
*   **代码实现**: `start.py` 中的 `check_account_safety`。

## 2. 技术实现细节

### 2.1 文件结构
*   `start.py`: 主程序，包含 `SymbolTrader` 类，负责账户监控、ATR 计算和策略调度。
*   `grid_strategy.py`: 策略核心，包含 `KalmanGridStrategy` 类，负责网格逻辑、倍数计算和信号生成。

### 2.2 关键函数
*   **`check_grid_add(positions, current_price, current_atr)`**: 
    *   接收实时 ATR，计算动态步长。
    *   判断是否满足加仓条件。
*   **`calculate_next_lot(current_count)`**:
    *   根据当前层数返回对应的加仓倍数。
*   **`check_account_safety()`**:
    *   执行最大回撤检查，必要时触发熔断。

## 3. 部署建议
*   **黄金 (XAUUSD)**: 建议基础手数 0.01，最大层数 20，回撤限制 20%。
*   **货币对 (EURUSD)**: 建议基础手数 0.01，最大层数 15，回撤限制 15%。
*   **时间周期**: 建议使用 M10 或 M15 周期进行 ATR 计算，以获得较稳定的波动率读数。
